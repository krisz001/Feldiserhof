<%- include('../partials/head', { 
  title: 'Speisekarte bearbeiten',
  description: 'Speisen, Getr√§nke und Kategorien verwalten, Preise aktualisieren.'
}) %>

<%- include('../partials/navbar') %>

<main class="container py-5 mt-5">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <h1 class="h2 text-primary mb-0">
            <i class="fas fa-utensils me-2"></i>
            <span>Speisekarte bearbeiten</span>
          </h1>
        </div>

        <div>
          <a href="/admin" class="btn btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i>Zur√ºck
          </a>
          <form id="logoutForm" method="post" action="/admin/logout" class="d-inline">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            <button class="btn btn-outline-danger" type="submit">
              <i class="fas fa-sign-out-alt me-1"></i>Abmelden
            </button>
          </form>
        </div>
      </div>

      <!-- üîπ Gyors m≈±veletek (JSON alap√∫ men√º) -->
      <div class="row mb-4">
        <div class="col-md-4">
          <button class="btn btn-success w-100" onclick="openCategoryModal()">
            <i class="fas fa-plus me-2"></i>Neue Kategorie
          </button>
        </div>
        <div class="col-md-4">
          <button class="btn btn-primary w-100" onclick="openItemModal()">
            <i class="fas fa-plus me-2"></i>Neuer Eintrag
          </button>
        </div>
        <div class="col-md-4">
          <button class="btn btn-info w-100" onclick="saveMenu()">
            <i class="fas fa-save me-2"></i>Speichern
          </button>
        </div>
      </div>

      <!-- üîπ PDF extra panel (opcion√°lis) -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0">
              <i class="fas fa-file-pdf me-2 text-danger"></i>
              PDF-Version der Speisekarte (optional)
            </h5>
            <small class="text-muted">
              Die PDF wird serverseitig in Seitenbilder umgewandelt und im Men√º-Buch angezeigt.
            </small>
          </div>
          <span class="badge bg-secondary" id="pdfStatusBadge">Keine PDF hochgeladen</span>
        </div>
        <div class="card-body">
          <form id="pdfUploadForm" class="row g-3">
            <div class="col-md-8">
              <label for="menuPdf" class="form-label">PDF-Datei w√§hlen</label>
              <input type="file" class="form-control" id="menuPdf" name="menuPdf" accept="application/pdf" required>
            </div>
            <div class="col-md-4 d-flex align-items-end gap-2">
              <button type="submit" class="btn btn-outline-primary flex-grow-1">
                <i class="fas fa-upload me-2"></i>PDF hochladen
              </button>
              <button type="button" class="btn btn-outline-danger" id="pdfDeleteBtn">
                <i class="fas fa-trash me-2"></i>PDF entfernen
              </button>
            </div>
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
          </form>

          <div id="pdfPreview" class="mt-3">
            <span class="text-muted small">Noch keine PDF-Version vorhanden.</span>
          </div>

          <!-- √öJ GOMB: PDF sorrend szerkeszt√©se -->
          <div class="mt-3">
            <a href="/admin/pdf-order" class="btn btn-outline-secondary w-100">
              <i class="fas fa-list-ol me-2"></i>PDF-oldalak sorrendj√©nek szerkeszt√©se
            </a>
          </div>
        </div>
      </div>

      <!-- üîπ Men√º szerkeszt≈ë (JSON alap√∫ ‚Äì marad, ahogy volt) -->
      <div class="card">
        <div class="card-body">
          <div id="menuEditor">
            <div class="text-center text-muted py-5" id="loadingMessage">
              <i class="fas fa-spinner fa-spin me-2"></i>Men√º wird geladen...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Kateg√≥ria Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalTitle">Neue Kategorie</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="categoryForm">
          <input type="hidden" id="categoryIndex" value="">
          <div class="mb-3">
            <label for="categoryName" class="form-label">Kategoriename</label>
            <input type="text" class="form-control" id="categoryName" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" onclick="saveCategory()">Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- T√©tel Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="itemModalTitle">Neuer Eintrag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="itemForm">
          <input type="hidden" id="itemCategoryIndex" value="">
          <input type="hidden" id="itemIndex" value="">
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="itemName" class="form-label">Name *</label>
                <input type="text" class="form-control" id="itemName" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="itemPrice" class="form-label">Preis (Fr) *</label>
                <input type="number" class="form-control" id="itemPrice" min="0" step="0.01" required>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="itemDescription" class="form-label">Beschreibung</label>
            <textarea class="form-control" id="itemDescription" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label for="itemTags" class="form-label">Tags (mit Komma getrennt)</label>
            <input type="text" class="form-control" id="itemTags" placeholder="hausgemacht, frisch, w√ºrzig">
          </div>

          <div class="mb-3">
            <label for="itemAllergens" class="form-label">Allergene (mit Komma getrennt)</label>
            <input type="text" class="form-control" id="itemAllergens" placeholder="Laktose, Gluten, N√ºsse">
          </div>

          <div class="mb-3">
            <label for="itemCategory" class="form-label">Kategorie w√§hlen... *</label>
            <select class="form-select" id="itemCategory" required>
              <option value="">Kategorie w√§hlen...</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" onclick="saveItem()">Speichern</button>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

<style>
.menu-category {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  margin-bottom: 1.5rem;
}
.menu-category-header {
  background: #f8f9fa;
  padding: 1rem;
  border-bottom: 1px solid #dee2e6;
}
.menu-item {
  padding: 1rem;
  border-bottom: 1px solid #f8f9fa;
}
.menu-item:last-child {
  border-bottom: none;
}
.allergen-badge {
  font-size: 0.7em;
  background: #dc3545;
  color: white;
}
.tag-badge {
  font-size: 0.7em;
  background: #6c757d;
  color: white;
}

/* PDF preview kis thumbnail-ek */
#pdfPreview .pdf-thumb {
  width: 70px;
  height: 100px;
  border-radius: 4px;
  overflow: hidden;
  border: 1px solid rgba(0,0,0,.1);
  box-shadow: 0 2px 4px rgba(0,0,0,.08);
}
#pdfPreview .pdf-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
</style>

<script>
let menuData = { title: "", categories: [] };
let csrfToken = '';
let pdfPages = [];

// Ford√≠t√°si stringek ‚Äì most m√°r fix n√©met sz√∂vegek
const translations = {
  errorLoadingMenu: 'Fehler beim Laden des Men√ºs.',
  noCategories: 'Noch keine Kategorien',
  noCategoriesHint: 'Beginnen Sie mit dem Erstellen einer neuen Kategorie!',
  noItemsInCategory: 'Noch keine Eintr√§ge in dieser Kategorie',
  editCategory: 'Kategorie bearbeiten',
  newCategory: 'Neue Kategorie',
  editItem: 'Eintrag bearbeiten',
  newItem: 'Neuer Eintrag',
  selectCategory: 'Kategorie w√§hlen...',
  categoryRequired: 'Kategoriename ist erforderlich!',
  namePriceCategoryRequired: 'Name, Preis und Kategorie sind erforderlich!',
  confirmDeleteCategory: 'Sind Sie sicher, dass Sie diese Kategorie l√∂schen m√∂chten?',
  confirmDeleteItem: 'Sind Sie sicher, dass Sie diesen Eintrag l√∂schen m√∂chten?',
  menuSaved: 'Men√º erfolgreich gespeichert!',
  errorSaving: 'Fehler beim Speichern: ',
  errorSavingMenu: 'Fehler beim Speichern des Men√ºs.'
};

// CSRF token lek√©r√©se
async function getCsrfToken() {
  if (!csrfToken) {
    try {
      const response = await fetch('/api/csrf-token');
      const data = await response.json();
      csrfToken = data.token;
    } catch (error) {
      console.error('CSRF token lek√©r√©si hiba:', error);
    }
  }
  return csrfToken;
}

// Men√º bet√∂lt√©se (JSON)
async function loadMenu() {
  try {
    const response = await fetch('/api/menu', {
      headers: { 'CSRF-Token': await getCsrfToken() }
    });
    if (!response.ok) throw new Error('Failed to load menu data');
    menuData = await response.json();
    renderMenu();
  } catch (error) {
    console.error('Hiba a men√º bet√∂lt√©sekor:', error);
    document.getElementById('loadingMessage').innerHTML = 
      `<div class="alert alert-danger">${translations.errorLoadingMenu}</div>`;
  }
}

// PDF st√°tusz bet√∂lt√©se
async function loadPdfMenuStatus() {
  try {
    const response = await fetch('/api/menu-pdf', {
      headers: { 'CSRF-Token': await getCsrfToken() }
    });
    if (!response.ok) throw new Error('Failed to load pdf menu');
    const data = await response.json();
    pdfPages = Array.isArray(data.pages) ? data.pages : [];
    updatePdfStatusUI();
  } catch (error) {
    console.error('Fehler beim Laden der PDF-Version:', error);
  }
}

function updatePdfStatusUI() {
  const badge = document.getElementById('pdfStatusBadge');
  const preview = document.getElementById('pdfPreview');
  if (!badge || !preview) return;

  if (!pdfPages.length) {
    badge.textContent = 'Keine PDF hochgeladen';
    badge.className = 'badge bg-secondary';
    preview.innerHTML = '<span class="text-muted small">Noch keine PDF-Version vorhanden.</span>';
  } else {
    badge.textContent = pdfPages.length + ' Seite(n)';
    badge.className = 'badge bg-success';

    const thumbs = pdfPages.slice(0, 3).map((url, idx) => `
      <div class="pdf-thumb">
        <img src="${url}" alt="Seite ${idx + 1}">
      </div>
    `).join('');

    const more = pdfPages.length > 3
      ? `<div class="small text-muted ms-2">+ ${pdfPages.length - 3} weitere...</div>`
      : '';

    preview.innerHTML = `
      <div class="d-flex align-items-center gap-2 flex-wrap">
        ${thumbs}
        ${more}
      </div>
    `;
  }
}

// PDF felt√∂lt√©s kezel√©se
async function handlePdfUpload(event) {
  event.preventDefault();
  const fileInput = document.getElementById('menuPdf');
  if (!fileInput || !fileInput.files.length) {
    alert('Bitte w√§hlen Sie eine PDF-Datei aus.');
    return;
  }

  const formData = new FormData();
  formData.append('menuPdf', fileInput.files[0]);
  formData.append('_csrf', await getCsrfToken());

  try {
    const response = await fetch('/admin/menu-pdf', {
      method: 'POST',
      body: formData
    });

    if (!response.ok) throw new Error('Upload failed');

    await loadPdfMenuStatus();
    fileInput.value = '';
  } catch (error) {
    console.error('Fehler beim PDF-Upload:', error);
    alert('Fehler beim Hochladen der PDF.');
  }
}

// PDF t√∂rl√©se
async function handlePdfDelete() {
  if (!confirm('M√∂chten Sie die aktuelle PDF-Version wirklich entfernen?')) return;

  try {
    const response = await fetch('/admin/menu-pdf/delete', {
      method: 'POST',
      headers: {
        'CSRF-Token': await getCsrfToken()
      }
    });

    if (!response.ok) throw new Error('Delete failed');

    pdfPages = [];
    updatePdfStatusUI();
  } catch (error) {
    console.error('Fehler beim L√∂schen der PDF:', error);
    alert('Fehler beim Entfernen der PDF-Version.');
  }
}

// HTML escape funkci√≥ XSS v√©delem miatt
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

// Men√º renderel√©se (JSON)
function renderMenu() {
  const container = document.getElementById('menuEditor');
  
  if (!menuData.categories || menuData.categories.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">${translations.noCategories}</h5>
        <p class="text-muted">${translations.noCategoriesHint}</p>
      </div>
    `;
    return;
  }

  let html = '';
  
  menuData.categories.forEach((category, catIndex) => {
    html += `
      <div class="menu-category">
        <div class="menu-category-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">${escapeHtml(category.name)}</h5>
          <div>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory(${catIndex})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${catIndex})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="menu-category-body">
    `;

    if (category.items && category.items.length > 0) {
      category.items.forEach((item, itemIndex) => {
        const tags = item.tags ? item.tags.map(tag => 
          `<span class="badge tag-badge me-1">${escapeHtml(tag)}</span>`
        ).join('') : '';
        
        const allergens = item.allergens ? item.allergens.map(allergen => 
          `<span class="badge allergen-badge me-1">${escapeHtml(allergen)}</span>`
        ).join('') : '';
        
        html += `
          <div class="menu-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${escapeHtml(item.name)}</h6>
                <p class="text-muted mb-1 small">${escapeHtml(item.desc || '')}</p>
                <div class="mb-1">
                  ${tags}
                  ${allergens}
                </div>
              </div>
              <div class="text-end ms-3">
                <div class="fw-bold text-primary mb-1">${Number(item.price).toFixed(2)} Fr</div>
                <div>
                  <button class="btn btn-sm btn-outline-primary me-1" onclick="editItem(${catIndex}, ${itemIndex})">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${catIndex}, ${itemIndex})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
    } else {
      html += `
        <div class="text-center py-4 text-muted">
          <i class="fas fa-utensils me-2"></i>${translations.noItemsInCategory}
        </div>
      `;
    }

    html += `</div></div>`;
  });

  container.innerHTML = html;
}

// Kateg√≥ria modal
function openCategoryModal(catIndex = null) {
  const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
  const form = document.getElementById('categoryForm');
  
  if (catIndex !== null) {
    document.getElementById('categoryModalTitle').textContent = translations.editCategory;
    document.getElementById('categoryIndex').value = catIndex;
    document.getElementById('categoryName').value = menuData.categories[catIndex].name;
  } else {
    document.getElementById('categoryModalTitle').textContent = translations.newCategory;
    document.getElementById('categoryIndex').value = '';
    form.reset();
  }
  
  modal.show();
}

// T√©tel modal
function openItemModal(catIndex = null, itemIndex = null) {
  const modal = new bootstrap.Modal(document.getElementById('itemModal'));
  const form = document.getElementById('itemForm');
  const categorySelect = document.getElementById('itemCategory');
  
  categorySelect.innerHTML = `<option value="">${translations.selectCategory}</option>`;
  menuData.categories.forEach((category, index) => {
    categorySelect.innerHTML += `<option value="${index}">${escapeHtml(category.name)}</option>`;
  });
  
  if (catIndex !== null && itemIndex !== null) {
    document.getElementById('itemModalTitle').textContent = translations.editItem;
    document.getElementById('itemCategoryIndex').value = catIndex;
    document.getElementById('itemIndex').value = itemIndex;
    
    const item = menuData.categories[catIndex].items[itemIndex];
    document.getElementById('itemName').value = item.name;
    document.getElementById('itemPrice').value = item.price;
    document.getElementById('itemDescription').value = item.desc || '';
    document.getElementById('itemTags').value = item.tags ? item.tags.join(', ') : '';
    document.getElementById('itemAllergens').value = item.allergens ? item.allergens.join(', ') : '';
    document.getElementById('itemCategory').value = catIndex;
  } else {
    document.getElementById('itemModalTitle').textContent = translations.newItem;
    document.getElementById('itemCategoryIndex').value = '';
    document.getElementById('itemIndex').value = '';
    form.reset();
    
    if (catIndex !== null) {
      document.getElementById('itemCategory').value = catIndex;
    }
  }
  
  modal.show();
}

// Kateg√≥ria ment√©se
function saveCategory() {
  const catIndex = document.getElementById('categoryIndex').value;
  const name = document.getElementById('categoryName').value.trim();
  
  if (!name) {
    alert(translations.categoryRequired);
    return;
  }
  
  if (catIndex === '') {
    if (!menuData.categories) menuData.categories = [];
    menuData.categories.push({
      name: name,
      items: []
    });
  } else {
    menuData.categories[catIndex].name = name;
  }
  
  bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
  renderMenu();
}

// T√©tel ment√©se
function saveItem() {
  const catIndex = document.getElementById('itemCategoryIndex').value !== '' ? 
    parseInt(document.getElementById('itemCategoryIndex').value) : null;
  const itemIndex = document.getElementById('itemIndex').value;
  const targetCatIndex = parseInt(document.getElementById('itemCategory').value);
  
  const name = document.getElementById('itemName').value.trim();
  const price = parseFloat(document.getElementById('itemPrice').value);
  const desc = document.getElementById('itemDescription').value.trim();
  const tags = document.getElementById('itemTags').value.split(',').map(t => t.trim()).filter(t => t);
  const allergens = document.getElementById('itemAllergens').value.split(',').map(a => a.trim()).filter(a => a);
  
  if (!name || !price || isNaN(price) || isNaN(targetCatIndex)) {
    alert(translations.namePriceCategoryRequired);
    return;
  }
  
  const itemData = {
    name: name,
    price: price,
    desc: desc || '',
    tags: tags,
    allergens: allergens
  };
  
  if (itemIndex === '') {
    if (!menuData.categories[targetCatIndex].items) {
      menuData.categories[targetCatIndex].items = [];
    }
    menuData.categories[targetCatIndex].items.push(itemData);
  } else {
    if (catIndex === targetCatIndex) {
      menuData.categories[catIndex].items[itemIndex] = itemData;
    } else {
      menuData.categories[catIndex].items.splice(itemIndex, 1);
      if (!menuData.categories[targetCatIndex].items) {
        menuData.categories[targetCatIndex].items = [];
      }
      menuData.categories[targetCatIndex].items.push(itemData);
    }
  }
  
  bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
  renderMenu();
}

// T√∂rl√©s funkci√≥k
function deleteCategory(index) {
  if (confirm(translations.confirmDeleteCategory)) {
    menuData.categories.splice(index, 1);
    renderMenu();
  }
}

function deleteItem(catIndex, itemIndex) {
  if (confirm(translations.confirmDeleteItem)) {
    menuData.categories[catIndex].items.splice(itemIndex, 1);
    renderMenu();
  }
}

// Szerkeszt√©s funkci√≥k
function editCategory(index) {
  openCategoryModal(index);
}

function editItem(catIndex, itemIndex) {
  openItemModal(catIndex, itemIndex);
}

// Men√º ment√©se a szerverre
async function saveMenu() {
  try {
    // 1. PDF oldalak lek√©r√©se
    const pdfResponse = await fetch('/api/menu-pdf', {
      headers: { 'CSRF-Token': await getCsrfToken() }
    });
    const pdfData = await pdfResponse.json();
    const pdfPages = Array.isArray(pdfData.pages) ? pdfData.pages : [];
    
    // 2. Ha vannak PDF oldalak, CSAK azok mennek el (nem kateg√≥ria)
    // Az /api/menu-book API ezt k√∂zvetlen√ºl feldolgozza
    if (pdfPages.length) {
      // PDF mode: a menuData-b≈ël kateg√≥ri√°kat kit√∂rl√ºnk, pdfPages lesz a teljes tartalom
      menuData = {
        title: 'Speisekarte',
        pdfMode: true,
        pdfPages: pdfPages,  // Csak az oldalk√©pek
        categories: []
      };
    }
    // Ha nincs PDF, az eredeti menuData marad (normal mode)
    
    // 3. Ment√©s szerverre
    const response = await fetch('/api/menu', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'CSRF-Token': await getCsrfToken()
      },
      body: JSON.stringify(menuData)
    });

    if (!response.ok) throw new Error('Failed to save menu');
    const result = await response.json();

    if (result.ok) {
      alert(translations.menuSaved);
    } else {
      alert(translations.errorSaving + (result.msg || 'Unbekannter Fehler'));
    }
    await loadMenu();
  } catch (error) {
    console.error('Hiba a men√º ment√©sekor:', error);
    alert(translations.errorSavingMenu);
  }
}


// Inicializ√°l√°s
document.addEventListener('DOMContentLoaded', function() {
  loadMenu();
  loadPdfMenuStatus();

  const pdfForm = document.getElementById('pdfUploadForm');
  if (pdfForm) {
    pdfForm.addEventListener('submit', handlePdfUpload);
  }
  const pdfDeleteBtn = document.getElementById('pdfDeleteBtn');
  if (pdfDeleteBtn) {
    pdfDeleteBtn.addEventListener('click', handlePdfDelete);
  }
});
</script>
