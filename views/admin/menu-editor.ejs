<%- include('../partials/head', { 
  title: 'Speisekarte bearbeiten',
  description: 'Speisen, Getränke und Kategorien verwalten, Preise aktualisieren.'
}) %>

<%- include('../partials/navbar') %>

<main class="container py-5 mt-5">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <h1 class="h2 text-primary mb-0">
            <i class="fas fa-utensils me-2"></i>
            <span>Speisekarte bearbeiten</span>
          </h1>

          <!-- Nyelvválasztó eltávolítva – csak Deutsch marad -->
        </div>

        <div>
          <a href="/admin" class="btn btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i>Zurück
          </a>
          <form id="logoutForm" method="post" action="/admin/logout" class="d-inline">
            <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
            <button class="btn btn-outline-danger" type="submit">
              <i class="fas fa-sign-out-alt me-1"></i>Abmelden
            </button>
          </form>
        </div>
      </div>

      <!-- Gyors műveletek -->
      <div class="row mb-4">
        <div class="col-md-4">
          <button class="btn btn-success w-100" onclick="openCategoryModal()">
            <i class="fas fa-plus me-2"></i>Neue Kategorie
          </button>
        </div>
        <div class="col-md-4">
          <button class="btn btn-primary w-100" onclick="openItemModal()">
            <i class="fas fa-plus me-2"></i>Neuer Eintrag
          </button>
        </div>
        <div class="col-md-4">
          <button class="btn btn-info w-100" onclick="saveMenu()">
            <i class="fas fa-save me-2"></i>Speichern
          </button>
        </div>
      </div>

      <!-- Menü szerkesztő -->
      <div class="card">
        <div class="card-body">
          <div id="menuEditor">
            <!-- Itt jelenik meg a menü szerkesztő -->
            <div class="text-center text-muted py-5" id="loadingMessage">
              <i class="fas fa-spinner fa-spin me-2"></i>Menü wird geladen...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Kategória Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalTitle">Neue Kategorie</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="categoryForm">
          <input type="hidden" id="categoryIndex" value="">
          <div class="mb-3">
            <label for="categoryName" class="form-label">Kategoriename</label>
            <input type="text" class="form-control" id="categoryName" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" onclick="saveCategory()">Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- Tétel Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="itemModalTitle">Neuer Eintrag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="itemForm">
          <input type="hidden" id="itemCategoryIndex" value="">
          <input type="hidden" id="itemIndex" value="">
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="itemName" class="form-label">Name *</label>
                <input type="text" class="form-control" id="itemName" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="itemPrice" class="form-label">Preis (Fr) *</label>
                <input type="number" class="form-control" id="itemPrice" min="0" step="0.01" required>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="itemDescription" class="form-label">Beschreibung</label>
            <textarea class="form-control" id="itemDescription" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label for="itemTags" class="form-label">Tags (mit Komma getrennt)</label>
            <input type="text" class="form-control" id="itemTags" placeholder="hausgemacht, frisch, würzig">
          </div>

          <div class="mb-3">
            <label for="itemAllergens" class="form-label">Allergene (mit Komma getrennt)</label>
            <input type="text" class="form-control" id="itemAllergens" placeholder="Laktose, Gluten, Nüsse">
          </div>

          <div class="mb-3">
            <label for="itemCategory" class="form-label">Kategorie wählen... *</label>
            <select class="form-select" id="itemCategory" required>
              <option value="">Kategorie wählen...</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" onclick="saveItem()">Speichern</button>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

<style>
.menu-category {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
  margin-bottom: 1.5rem;
}
.menu-category-header {
  background: #f8f9fa;
  padding: 1rem;
  border-bottom: 1px solid #dee2e6;
}
.menu-item {
  padding: 1rem;
  border-bottom: 1px solid #f8f9fa;
}
.menu-item:last-child {
  border-bottom: none;
}
.allergen-badge {
  font-size: 0.7em;
  background: #dc3545;
  color: white;
}
.tag-badge {
  font-size: 0.7em;
  background: #6c757d;
  color: white;
}
</style>

<script>
let menuData = { title: "", categories: [] };
let csrfToken = '';

// Fordítási stringek – most már fix német szövegek
const translations = {
  errorLoadingMenu: 'Fehler beim Laden des Menüs.',
  noCategories: 'Noch keine Kategorien',
  noCategoriesHint: 'Beginnen Sie mit dem Erstellen einer neuen Kategorie!',
  noItemsInCategory: 'Noch keine Einträge in dieser Kategorie',
  editCategory: 'Kategorie bearbeiten',
  newCategory: 'Neue Kategorie',
  editItem: 'Eintrag bearbeiten',
  newItem: 'Neuer Eintrag',
  selectCategory: 'Kategorie wählen...',
  categoryRequired: 'Kategoriename ist erforderlich!',
  namePriceCategoryRequired: 'Name, Preis und Kategorie sind erforderlich!',
  confirmDeleteCategory: 'Sind Sie sicher, dass Sie diese Kategorie löschen möchten?',
  confirmDeleteItem: 'Sind Sie sicher, dass Sie diesen Eintrag löschen möchten?',
  menuSaved: 'Menü erfolgreich gespeichert!',
  errorSaving: 'Fehler beim Speichern: ',
  errorSavingMenu: 'Fehler beim Speichern des Menüs.'
};

// CSRF token lekérése
async function getCsrfToken() {
  if (!csrfToken) {
    try {
      const response = await fetch('/api/csrf-token');
      const data = await response.json();
      csrfToken = data.token;
    } catch (error) {
      console.error('CSRF token lekérési hiba:', error);
    }
  }
  return csrfToken;
}

// Menü betöltése
async function loadMenu() {
  try {
    const response = await fetch('/api/menu', {
      headers: { 'CSRF-Token': await getCsrfToken() }
    });
    if (!response.ok) throw new Error('Failed to load menu data');
    menuData = await response.json();
    renderMenu();
  } catch (error) {
    console.error('Hiba a menü betöltésekor:', error);
    document.getElementById('loadingMessage').innerHTML = 
      `<div class="alert alert-danger">${translations.errorLoadingMenu}</div>`;
  }
}

// HTML escape funkció XSS védelem miatt
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

// Menü renderelése
function renderMenu() {
  const container = document.getElementById('menuEditor');
  
  if (!menuData.categories || menuData.categories.length === 0) {
    container.innerHTML = `
      <div class="text-center py-5">
        <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">${translations.noCategories}</h5>
        <p class="text-muted">${translations.noCategoriesHint}</p>
      </div>
    `;
    return;
  }

  let html = '';
  
  menuData.categories.forEach((category, catIndex) => {
    html += `
      <div class="menu-category">
        <div class="menu-category-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">${escapeHtml(category.name)}</h5>
          <div>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory(${catIndex})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${catIndex})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="menu-category-body">
    `;

    if (category.items && category.items.length > 0) {
      category.items.forEach((item, itemIndex) => {
        const tags = item.tags ? item.tags.map(tag => 
          `<span class="badge tag-badge me-1">${escapeHtml(tag)}</span>`
        ).join('') : '';
        
        const allergens = item.allergens ? item.allergens.map(allergen => 
          `<span class="badge allergen-badge me-1">${escapeHtml(allergen)}</span>`
        ).join('') : '';
        
        html += `
          <div class="menu-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${escapeHtml(item.name)}</h6>
                <p class="text-muted mb-1 small">${escapeHtml(item.desc || '')}</p>
                <div class="mb-1">
                  ${tags}
                  ${allergens}
                </div>
              </div>
              <div class="text-end ms-3">
                <div class="fw-bold text-primary mb-1">${Number(item.price).toFixed(2)} Fr</div>
                <div>
                  <button class="btn btn-sm btn-outline-primary me-1" onclick="editItem(${catIndex}, ${itemIndex})">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${catIndex}, ${itemIndex})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
    } else {
      html += `
        <div class="text-center py-4 text-muted">
          <i class="fas fa-utensils me-2"></i>${translations.noItemsInCategory}
        </div>
      `;
    }

    html += `</div></div>`;
  });

  container.innerHTML = html;
}

// Kategória modal
function openCategoryModal(catIndex = null) {
  const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
  const form = document.getElementById('categoryForm');
  
  if (catIndex !== null) {
    document.getElementById('categoryModalTitle').textContent = translations.editCategory;
    document.getElementById('categoryIndex').value = catIndex;
    document.getElementById('categoryName').value = menuData.categories[catIndex].name;
  } else {
    document.getElementById('categoryModalTitle').textContent = translations.newCategory;
    document.getElementById('categoryIndex').value = '';
    form.reset();
  }
  
  modal.show();
}

// Tétel modal
function openItemModal(catIndex = null, itemIndex = null) {
  const modal = new bootstrap.Modal(document.getElementById('itemModal'));
  const form = document.getElementById('itemForm');
  const categorySelect = document.getElementById('itemCategory');
  
  // Kategóriák betöltése a select-be
  categorySelect.innerHTML = `<option value="">${translations.selectCategory}</option>`;
  menuData.categories.forEach((category, index) => {
    categorySelect.innerHTML += `<option value="${index}">${escapeHtml(category.name)}</option>`;
  });
  
  if (catIndex !== null && itemIndex !== null) {
    document.getElementById('itemModalTitle').textContent = translations.editItem;
    document.getElementById('itemCategoryIndex').value = catIndex;
    document.getElementById('itemIndex').value = itemIndex;
    
    const item = menuData.categories[catIndex].items[itemIndex];
    document.getElementById('itemName').value = item.name;
    document.getElementById('itemPrice').value = item.price;
    document.getElementById('itemDescription').value = item.desc || '';
    document.getElementById('itemTags').value = item.tags ? item.tags.join(', ') : '';
    document.getElementById('itemAllergens').value = item.allergens ? item.allergens.join(', ') : '';
    document.getElementById('itemCategory').value = catIndex;
  } else {
    document.getElementById('itemModalTitle').textContent = translations.newItem;
    document.getElementById('itemCategoryIndex').value = '';
    document.getElementById('itemIndex').value = '';
    form.reset();
    
    if (catIndex !== null) {
      document.getElementById('itemCategory').value = catIndex;
    }
  }
  
  modal.show();
}

// Kategória mentése
function saveCategory() {
  const catIndex = document.getElementById('categoryIndex').value;
  const name = document.getElementById('categoryName').value.trim();
  
  if (!name) {
    alert(translations.categoryRequired);
    return;
  }
  
  if (catIndex === '') {
    if (!menuData.categories) menuData.categories = [];
    menuData.categories.push({
      name: name,
      items: []
    });
  } else {
    menuData.categories[catIndex].name = name;
  }
  
  bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
  renderMenu();
}

// Tétel mentése
function saveItem() {
  const catIndex = document.getElementById('itemCategoryIndex').value !== '' ? 
    parseInt(document.getElementById('itemCategoryIndex').value) : null;
  const itemIndex = document.getElementById('itemIndex').value;
  const targetCatIndex = parseInt(document.getElementById('itemCategory').value);
  
  const name = document.getElementById('itemName').value.trim();
  const price = parseFloat(document.getElementById('itemPrice').value);
  const desc = document.getElementById('itemDescription').value.trim();
  const tags = document.getElementById('itemTags').value.split(',').map(t => t.trim()).filter(t => t);
  const allergens = document.getElementById('itemAllergens').value.split(',').map(a => a.trim()).filter(a => a);
  
  if (!name || !price || isNaN(price) || isNaN(targetCatIndex)) {
    alert(translations.namePriceCategoryRequired);
    return;
  }
  
  const itemData = {
    name: name,
    price: price,
    desc: desc || '',
    tags: tags,
    allergens: allergens
  };
  
  if (itemIndex === '') {
    if (!menuData.categories[targetCatIndex].items) {
      menuData.categories[targetCatIndex].items = [];
    }
    menuData.categories[targetCatIndex].items.push(itemData);
  } else {
    if (catIndex === targetCatIndex) {
      menuData.categories[catIndex].items[itemIndex] = itemData;
    } else {
      menuData.categories[catIndex].items.splice(itemIndex, 1);
      if (!menuData.categories[targetCatIndex].items) {
        menuData.categories[targetCatIndex].items = [];
      }
      menuData.categories[targetCatIndex].items.push(itemData);
    }
  }
  
  bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
  renderMenu();
}

// Törlés funkciók
function deleteCategory(index) {
  if (confirm(translations.confirmDeleteCategory)) {
    menuData.categories.splice(index, 1);
    renderMenu();
  }
}

function deleteItem(catIndex, itemIndex) {
  if (confirm(translations.confirmDeleteItem)) {
    menuData.categories[catIndex].items.splice(itemIndex, 1);
    renderMenu();
  }
}

// Szerkesztés funkciók
function editCategory(index) {
  openCategoryModal(index);
}

function editItem(catIndex, itemIndex) {
  openItemModal(catIndex, itemIndex);
}

// Menü mentése a szerverre
async function saveMenu() {
  try {
    const response = await fetch('/api/menu', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'CSRF-Token': await getCsrfToken()
      },
      body: JSON.stringify(menuData)
    });

    if (!response.ok) throw new Error('Failed to save menu');

    const result = await response.json();
    
    if (result.ok) {
      alert(translations.menuSaved);
    } else {
      alert(translations.errorSaving + (result.msg || 'Unbekannter Fehler'));
    }
  } catch (error) {
    console.error('Hiba a menü mentésekor:', error);
    alert(translations.errorSavingMenu);
  }
}

// Inicializálás
document.addEventListener('DOMContentLoaded', function() {
  loadMenu();
});
</script>
