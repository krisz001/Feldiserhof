<!-- views/partials/rooms.ejs -->
<section id="rooms" class="rooms-section">
  <div class="container zimmer-container">

    <% /* ---------- SAFE FALLBACKS + NORMALIZ√ÅL√ÅS ---------- */ %>
    <%
      // F≈ëc√≠mek
      const ROOMS_BADGE = (typeof roomsBadge !== 'undefined' && String(roomsBadge).trim()) ? roomsBadge : 'UNSERE ZIMMER';
      const ROOMS_TITLE = (typeof roomsTitle !== 'undefined' && String(roomsTitle).trim()) ? roomsTitle : 'Unsere Zimmer im Alpenstil';
      const ROOMS_LEAD  = (typeof roomsLead  !== 'undefined' && String(roomsLead).trim())  ? roomsLead  : 'Erleben Sie gem√ºtliche Wohlf√ºhlmomente in unseren liebevoll eingerichteten Zimmern ‚Äì jedes davon im traditionellen Alpenstil gestaltet, mit viel Holz, warmen Farben und einem Hauch von Bergromantik. Hier finden Sie Ruhe, Herzlichkeit und den perfekten Ort zum Entspannen.';

      // Feature flag (SSR-b≈ël j√∂n; ha nincs, legyen enged√©lyezve)
      const MENU_BOOK_ENABLED = (typeof flags !== 'undefined' && flags && typeof flags.menuBookEnabled === 'boolean')
        ? flags.menuBookEnabled
        : true;

      // Fallback szob√°k
      const FALLBACK_ROOMS = [
        {
          id: 'doppelzimmer',
          icon: 'üõè',
          title: 'Doppelzimmer im Alpenstil',
          description: 'F√ºhlen Sie sich wohl in unserem liebevoll eingerichteten Doppelzimmer im gem√ºtlichen Alpenstil. Warme Holzelemente und nat√ºrliche Materialien schaffen eine behagliche Atmosph√§re zum Ankommen und Durchatmen. Das Zimmer bietet ein komfortables Doppelbett, ein einfaches Bad mit Dusche/WC, F√∂hn und Pflegeprodukte. Ein TV sorgt f√ºr Unterhaltung, und auf dem Balkon mit Blick auf die Alpen genie√üen Sie herrliche Ausblicke und frische Bergluft. Auf Wunsch stellen wir gerne ein gratis Kinderbett zur Verf√ºgung. Ein Ort zum Entspannen, Tr√§umen und die Sch√∂nheit der Berge zu sp√ºren.',
          features: ['Doppelbett', 'Balkon mit Alpenblick', 'Dusche/WC', 'TV'],
          price: 'Fr 180.‚Äì',
          priceDetails: 'pro Zimmer ¬∑ 2 Personen ¬∑ inkl. Fr√ºhst√ºck ¬∑ pro Nacht',
          image: '/img/rooms/doppelzimmer.jpg'
        },
        {
          id: 'einzelbelegung',
          icon: 'üßç‚Äç‚ôÄÔ∏è',
          title: 'Einzelbelegung im Doppelzimmer',
          description: 'F√ºr alle, die sich etwas mehr Raum und Ruhe g√∂nnen m√∂chten: Unsere Einzelbelegung im Doppelzimmer vereint Komfort und Gem√ºtlichkeit im typischen Alpenstil. Das Zimmer ist mit einem Doppelbett zur Alleinbenutzung, Dusche/WC, F√∂hn und Pflegeprodukten ausgestattet. Ein TV sorgt f√ºr Unterhaltung, und vom Balkon aus genie√üen Sie den Blick auf die Alpen, um den Tag entspannt ausklingen zu lassen. Auch hier kann auf Wunsch ein gratis Kinderbett bereitgestellt werden. Ihr pers√∂nlicher R√ºckzugsort in den Bergen ‚Äì ruhig, herzlich und erholsam.',
          features: ['Doppelbett zur Alleinbenutzung', 'Balkon', 'Dusche/WC', 'TV'],
          price: 'Fr 120.‚Äì',
          priceDetails: 'pro Zimmer ¬∑ 1 Person ¬∑ inkl. Fr√ºhst√ºck ¬∑ pro Nacht',
          image: '/img/rooms/einzelbelegung.jpg'
        },
        {
          id: 'familienzimmer',
          icon: 'üè°',
          title: 'Familienzimmer im Alpenstil',
          description: 'Ideal f√ºr Familien oder Freunde, die gemeinsam Urlaub in den Bergen genie√üen m√∂chten. Unser ger√§umiges Familienzimmer vereint gem√ºtlichen Alpencharme mit praktischem Komfort. Es bietet zwei getrennte Schlafbereiche mit Doppelbett und Einzel- oder Stockbetten, ein Bad mit Dusche/WC, F√∂hn und Pflegeprodukte. Ein TV sorgt f√ºr Unterhaltung, und vom Balkon mit herrlicher Sicht auf die Alpen erleben Sie gemeinsame Momente voller Ruhe und Freude. Ein gratis Kinderbett kann gerne dazu reserviert werden.',
          features: ['2 Schlafbereiche', 'Balkon mit Alpenblick', 'Dusche/WC', 'TV', 'Kinderbett m√∂glich'],
          price: 'Fr 220.‚Äì',
          priceDetails: 'pro Nacht ¬∑ 2 Erwachsene + 2 Kinder ¬∑ inkl. Fr√ºhst√ºck',
          image: '/img/rooms/familienzimmer.jpg'
        },
        {
          id: 'hunde-willkommen',
          icon: 'üêæ',
          title: 'Doppelzimmer ‚Äì Hunde willkommen',
          description: 'Auch Vierbeiner sind bei uns herzlich willkommen! In unserem gem√ºtlichen Doppelzimmer im Alpenstil f√ºhlen sich Mensch und Hund gleicherma√üen wohl. Warme Holzelemente und nat√ºrliche Materialien schaffen eine behagliche Atmosph√§re. Das Zimmer bietet ein komfortables Doppelbett, Dusche/WC, F√∂hn und Pflegeprodukte. Ein TV sorgt f√ºr Unterhaltung, und vom Balkon mit wundersch√∂ner Sicht auf die Alpen genie√üen Sie frische Bergluft und herrliche Ausblicke.',
          features: ['Doppelbett', 'Hundefreundlich', 'Balkon', 'Dusche/WC', 'TV'],
          price: 'Fr 200.‚Äì',
          priceDetails: 'pro Zimmer ¬∑ 2 Personen ¬∑ inkl. Fr√ºhst√ºck ¬∑ pro Nacht',
          image: '/img/rooms/hunde-zimmer.jpg'
        },
        {
          id: 'gruppenzimmer',
          icon: 'üë•',
          title: 'Gruppenzimmer im Hotel ‚Äì ideal f√ºr Familien, Vereine oder Schulklassen',
          description: 'Unser gem√ºtliches Gruppenzimmer bietet Platz f√ºr bis zu 13 Personen und ist perfekt geeignet f√ºr Familien, Freunde oder Gruppenreisen. Die Unterkunft √ºberzeugt durch ihre freundliche Atmosph√§re und praktische Raumaufteilung. Im Aufenthaltsraum k√∂nnen sich alle G√§ste entspannen oder gemeinsam den Tag ausklingen lassen. Der Essraum mit Sitzplatz l√§dt zu gemeinsamen Mahlzeiten und gem√ºtlichem Beisammensein ein. Selbstverst√§ndlich steht kostenloses WLAN im gesamten Bereich zur Verf√ºgung. Verpflegung wahlweise mit Halbpension oder Vollpension.',
          features: [
            '2 Vierbettzimmer',
            '1 Dreibettzimmer',
            'Studio mit 2 Zimmern (inkl. Dusche/WC)',
            'Zus√§tzliches Etagenbad',
            'Gem√ºtlicher Aufenthaltsraum',
            'Essraum mit Sitzplatz',
            'WLAN inklusive',
            'Halb- oder Vollpension m√∂glich'
          ],
          // Megmutatjuk a k√©tdobozos p√©ld√°t fallbackk√©nt is:
          priceTiers: [
            { label: 'Preis', amount: 'ab Fr 65.‚Äì', details: 'pro Person ¬∑ Gruppenzimmer ¬∑ inkl. Fr√ºhst√ºck ¬∑ pro Nacht' },
            { label: 'Studio (2 Zimmer)', amount: 'Fr 210.‚Äì', details: 'pro Nacht ¬∑ inkl. Fr√ºhst√ºck' }
          ],
          image: '/img/rooms/gruppenzimmer.jpg'
        }
      ];

      // Forr√°sadatok
      const RAW_DATA = (typeof roomsData !== 'undefined' && Array.isArray(roomsData) && roomsData.length)
        ? roomsData
        : FALLBACK_ROOMS;

      // Normaliz√°l√°s: paragraphs ‚Üí description, price object ‚Üí stringek, priceTiers auto-sz√©tv√°g√°s
      const extractAmount = (s='') => {
        const m = String(s).match(/Fr\s?\d+[.,‚Äì-]*/);
        return m ? m[0].replace(',', '.') : '';
      };

      const ROOM_DATA = RAW_DATA.map((r, idx) => {
        const id       = r.id || `room-${idx}`;
        const title    = r.title || 'Zimmer';
        const features = Array.isArray(r.features) ? r.features : [];
        const image    = r.image || '/img/rooms/placeholder.jpg';
        const icon     = r.icon || r.emoji || '';
        const iconClass= r.iconClass || '';

        const description =
          (typeof r.description === 'string' && r.description.trim())
            ? r.description.trim()
            : (Array.isArray(r.paragraphs) ? r.paragraphs.join(' ') : '');

        // Alap √°r mez≈ëk
        let price = '';
        let priceDetails = '';
        if (typeof r.price === 'string') {
          price = r.price;
        } else if (r.price && typeof r.price === 'object') {
          price = r.price.amount || '';
          priceDetails = r.price.label || '';
        }
        if (typeof r.priceDetails === 'string') {
          priceDetails = r.priceDetails;
        }

        // K√©tdobozos √°r ‚Äì els≈ëbbs√©g: r.priceTiers; ha nincs, pr√≥b√°lunk a priceDetails '|' alapj√°n kett√© szedni
        let priceTiers = Array.isArray(r.priceTiers) ? r.priceTiers.slice(0, 3) : null;
        if (!priceTiers && typeof priceDetails === 'string' && priceDetails.includes('|')) {
          const parts = priceDetails.split('|').map(s => s.trim());
          const left  = parts[0] || '';
          const right = parts[1] || '';
          priceTiers = [
            { label: 'Preis', amount: price || extractAmount(left),  details: left.replace(extractAmount(left), '').trim().replace(/^¬∑\s*/,'') },
            { label: 'Preis', amount: extractAmount(right), details: right.replace(extractAmount(right), '').trim().replace(/^¬∑\s*/,'') }
          ];
          // Ha k√©tdobozra v√°ltunk, a sima price boxot ne jelen√≠ts√ºk meg
          price = '';
          priceDetails = '';
        }

        return { id, title, description, features, image, icon, iconClass, price, priceDetails, priceTiers };
      });
    %>

    <!-- Intro Section -->
    <section class="intro">
      <span class="badge"><%= ROOMS_BADGE %></span>
      <h1 class="intro__title"><%= ROOMS_TITLE %></h1>
      <p class="intro__lead"><%= ROOMS_LEAD %></p>
    </section>

    <!-- Zimmer Grid -->
    <div class="zimmer-grid" role="list">
      <% ROOM_DATA.forEach((room, index) => { %>
        <article class="room-card" id="<%= room.id %>" data-room-index="<%= index %>" role="listitem" aria-labelledby="room-title-<%= index %>">

          <!-- K√©p -->
          <div class="room-card__image-wrapper">
            <img
              src="<%= room.image %>"
              alt="<%= room.title %>"
              class="room-card__image"
              loading="lazy"
              onerror="this.src='/img/rooms/placeholder.jpg'; this.alt='Zimmer';">
          </div>

          <!-- Tartalom -->
          <div class="room-card__content">
            <div class="room-card__icon" aria-hidden="true">
              <% if (room.iconClass) { %>
                <i class="<%= room.iconClass %>"></i>
              <% } else if (room.icon) { %>
                <span><%= room.icon %></span>
              <% } %>
            </div>

            <h2 class="room-card__title" id="room-title-<%= index %>"><%= room.title %></h2>

            <% if (room.description) { %>
              <p class="room-card__description"><%= room.description %></p>
            <% } %>

            <!-- Features -->
            <% if (room.features && room.features.length) { %>
              <div class="room-card__features" role="list" aria-label="Ausstattung">
                <% room.features.forEach((feature) => { %>
                  <span class="feature-tag" role="listitem" aria-label="<%= feature %>">
                    <i class="fas fa-check" aria-hidden="true"></i>
                    <%= feature %>
                  </span>
                <% }) %>
              </div>
            <% } %>

            <!-- √År: vagy egy doboz, vagy k√©t mini-doboz -->
            <% if (room.priceTiers && room.priceTiers.length) { %>
              <div class="room-price-grid" aria-label="Preisvarianten">
                <% room.priceTiers.forEach((pt, i) => { %>
                  <div class="price-tier" role="group" aria-label="<%= pt.label || ('Variante ' + (i+1)) %>">
                    <div class="price-tier__label"><%= pt.label || 'Preis' %></div>
                    <% if (pt.amount) { %><div class="price-tier__amount"><%= pt.amount %></div><% } %>
                    <% if (pt.details) { %><div class="price-tier__details"><%= pt.details %></div><% } %>
                  </div>
                <% }) %>
              </div>
            <% } else if (room.price || room.priceDetails) { %>
              <div class="room-card__price-box" aria-label="Preisbox">
                <div class="room-card__price-label">Preis</div>
                <% if (room.price) { %><div class="room-card__price-amount"><%= room.price %></div><% } %>
                <% if (room.priceDetails) { %><div class="room-card__price-details"><%= room.priceDetails %></div><% } %>
              </div>
            <% } %>

            <!-- CTA (feature flag szerint) -->
            <% if (MENU_BOOK_ENABLED) { %>
            <% } %>
          </div>
        </article>
      <% }) %>
    </div>

    <!-- Info -->
    <div class="alert alert-info rooms-note" role="note" style="margin-top:2rem;">
      Gerne machen wir Ihnen Offerte f√ºr ab 4 Tagen.
    </div>

  </div>
</section>

<div class="section-separator"></div>
