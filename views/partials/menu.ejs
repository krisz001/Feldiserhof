<%
  const categories = Array.isArray(menuData?.categories) ? menuData.categories : [];
  const titleTxt    = t('menu.title',    { defaultValue: 'Speisekarte' });
  const subtitleTxt = t('menu.subtitle', { defaultValue: 'Entdecken Sie unsere K√ºche' });
  const introTxt    = t('menu.intro',    { defaultValue: 'Frisch, saisonal, regional ‚Äì t√§glich f√ºr Sie.' });

  // ===== Front √©s back k√ºl√∂n =====
  const ITEMS_PER_SIDE = 4; // egy OLDALON max 4 elem
  const sheets = [];        // egy "sheet" = front + back

  categories.forEach((cat, catIndex) => {
    const items = Array.isArray(cat.items) ? cat.items : [];
    const baseName = cat.name || `Kategorie ${catIndex + 1}`;
    let pageNoInCat = 1;

    for (let i = 0; i < items.length; i += ITEMS_PER_SIDE * 2) {
      // FRONT
      const frontItems = items.slice(i, i + ITEMS_PER_SIDE);
      const frontTitle = pageNoInCat === 1 ? baseName : `${baseName} (${pageNoInCat})`;

      // BACK
      const backItems = items.slice(i + ITEMS_PER_SIDE, i + ITEMS_PER_SIDE * 2);
      const backTitle = backItems.length > 0 ? `${baseName} (${pageNoInCat + 1})` : null;

      sheets.push({
        front: { title: frontTitle, items: frontItems },
        back : backItems.length ? { title: backTitle, items: backItems } : null
      });

      pageNoInCat += backItems.length ? 2 : 1;
    }
  });

  // Folyamatos lapsz√°moz√°s a t√©nylegesen megjelen≈ë oldalak alapj√°n
  let pageCounter = 1;
%>

<section id="menu" class="menu-section">
  <header class="menu-header text-center mb-5">
    <span class="menu-icon" aria-hidden="true">üç¥</span>
    <h2 class="menu-title"><%= titleTxt %></h2>
    <div class="menu-divider"></div>
    <p class="menu-subtitle"><%= subtitleTxt %></p>
    <p class="menu-intro"><%= introTxt %></p>
  </header>

  <!-- üîí wrapper kap felt√©teles locked √°llapotot -->
  <div class="menu-portfolio <%= flags?.menuBookEnabled ? '' : 'is-locked' %>">
    <div class="wrapper">

      <!-- üîí ha tiltva van, mutatjuk az overlay √ºzenetet -->
      <% if (!flags?.menuBookEnabled) { %>
        <div class="book-lock-overlay" role="status" aria-live="polite">
          <div class="blo-card">
            <h3>Wegen Betriebsferien ist unsere Speisekarte momentan nicht verf√ºgbar.</h3>
            <p>Wir freuen uns, Sie bald wieder begr√º√üen zu d√ºrfen.</p>
          </div>
        </div>
      <% } %>

      <div class="cover cover-left" aria-hidden="true"></div>
      <div class="cover cover-right" aria-hidden="true"></div>

      <div class="book" id="menuBook">
        <!-- Bal nyit√≥ oldal -->
        <div class="book-page page-left">
          <div class="profile-page profile-cover">
            <h1><%= titleTxt %></h1>
            <p><%= subtitleTxt %></p>
          </div>
        </div>

        <% if (sheets.length === 0) { %>
          <!-- √úres √°llapot: 1 jobb oldal -->
          <div class="book-page page-right" data-sheet="1" id="turn-1">
            <div class="page-front">
              <h1 class="title"><%= titleTxt %></h1>
              <p>Derzeit sind keine Men√ºdaten vorhanden.</p>
              <span class="number-page"><%= pageCounter %></span>
              <span class="nextprev-btn" data-role="next"><i class="bx bx-chevron-right"></i></span>
            </div>
            <div class="page-back">
              <span class="number-page"><%= pageCounter + 1 %></span>
              <span class="nextprev-btn back" data-role="prev"><i class="bx bx-chevron-left"></i></span>
            </div>
          </div>
        <% } else { %>
          <% sheets.forEach((sheet, sheetIndex) => { 
               const sheetId = `turn-${sheetIndex + 1}`;
               const frontNo = pageCounter;
               const backNo  = sheet.back ? pageCounter + 1 : null;
          %>
            <div class="book-page page-right" data-sheet="1" id="<%= sheetId %>">
              <!-- FRONT -->
              <div class="page-front">
                <h1 class="title"><%= sheet.front.title %></h1>
                <div class="menu-items-grid">
                  <% sheet.front.items.forEach(item => { %>
                    <article class="menu-item">
                      <div class="mi-head">
                        <h4 class="mi-name"><%- item.name || '' %></h4>
                        <% if (item.price != null && item.price !== '') { %>
                          <div class="mi-price">
                            <%= typeof item.price === 'number' ? item.price.toFixed(2) + ' fr' : String(item.price) %>
                          </div>
                        <% } %>
                      </div>
                      <% if (item.desc) { %><p class="mi-desc"><%- item.desc %></p><% } %>
                      <% if (item.tags && item.tags.length) { %>
                        <ul class="mi-tags">
                          <% item.tags.forEach(tag => { %><li><%- tag %></li><% }) %>
                        </ul>
                      <% } %>
                      <% if (item.allergens && item.allergens.length) { %>
                        <ul class="mi-tags allergens">
                          <% item.allergens.forEach(a => { %><li class="allergen"><%- a %></li><% }) %>
                        </ul>
                      <% } %>
                    </article>
                  <% }) %>
                </div>
                <span class="number-page"><%= frontNo %></span>
                <span class="nextprev-btn" data-role="next"><i class="bx bx-chevron-right"></i></span>
              </div>

              <!-- BACK -->
              <div class="page-back">
                <% if (sheet.back) { %>
                  <h1 class="title"><%= sheet.back.title %></h1>
                  <div class="menu-items-grid">
                    <% sheet.back.items.forEach(item => { %>
                      <article class="menu-item">
                        <div class="mi-head">
                          <h4 class="mi-name"><%- item.name || '' %></h4>
                          <% if (item.price != null && item.price !== '') { %>
                            <div class="mi-price">
                              <%= typeof item.price === 'number' ? item.price.toFixed(2) + ' fr' : String(item.price) %>
                            </div>
                          <% } %>
                        </div>
                        <% if (item.desc) { %><p class="mi-desc"><%- item.desc %></p><% } %>
                        <% if (item.tags && item.tags.length) { %>
                          <ul class="mi-tags">
                            <% item.tags.forEach(tag => { %><li><%- tag %></li><% }) %>
                          </ul>
                        <% } %>
                        <% if (item.allergens && item.allergens.length) { %>
                          <ul class="mi-tags allergens">
                            <% item.allergens.forEach(a => { %><li class="allergen"><%- a %></li><% }) %>
                          </ul>
                        <% } %>
                      </article>
                    <% }) %>
                  </div>
                <% } else { %>
                  <div class="profile-page">
                    <h1 class="title">Vielen Dank!</h1>
                    <p>Wir w√ºnschen einen guten Appetit</p>
                  </div>
                <% } %>
                <span class="number-page"><%= backNo ?? '' %></span>
                <span class="nextprev-btn back" data-role="prev"><i class="bx bx-chevron-left"></i></span>
              </div>
            </div>
            <% pageCounter += sheet.back ? 2 : 1; %>
          <% }); %>
        <% } %>
      </div>
    </div>
    <div class="book-dots"></div>
  </div>

  <link rel="stylesheet" href="/css/menu-portfolio-book.css">
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
</section>
<div class="section-separator"></div>

<!-- üîΩ csak ehhez az opci√≥hoz sz√ºks√©ges minim√°l st√≠lus -->
<style>
  .menu-portfolio .wrapper { position: relative; }
  .menu-portfolio.is-locked .cover,
  .menu-portfolio.is-locked .book {
    filter: blur(14px) brightness(0.85) saturate(0.9);
    pointer-events: none !important;
    user-select: none !important;
  }
  .book-lock-overlay{
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    padding: 24px;
    background: radial-gradient(ellipse at center, rgba(0,0,0,.18), rgba(0,0,0,.28));
    z-index: 999;
  }
  .book-lock-overlay .blo-card{
    max-width: 720px; width: 100%;
    text-align: center; padding: 28px 24px; border-radius: 16px;
    background: rgba(255,255,255,.9);
    box-shadow: 0 20px 60px rgba(0,0,0,.25);
    backdrop-filter: blur(4px);
  }
  .book-lock-overlay .blo-card h3{ margin:0 0 8px; font-weight:700; font-size: clamp(1.1rem,2.2vw,1.5rem); color:#2b2b2b; }
  .book-lock-overlay .blo-card p { margin:0; font-size: clamp(.95rem,2vw,1.05rem); color:#444; }

  @media (prefers-color-scheme: dark){
    .book-lock-overlay .blo-card{ background: rgba(26,26,26,.92); color:#eee; }
    .book-lock-overlay .blo-card h3{ color:#fff; }
    .book-lock-overlay .blo-card p { color:#ddd; }
  }

  /* finom "shake", ha tiltott √°llapotban pr√≥b√°l lapozni (ha haszn√°lod) */
  @keyframes book-shake{
    10%,90%{transform:translateX(-1px)}
    20%,80%{transform:translateX(2px)}
    30%,50%,70%{transform:translateX(-4px)}
    40%,60%{transform:translateX(4px)}
  }
  .menu-portfolio .book.shake{ animation: book-shake .4s both; }
</style>
