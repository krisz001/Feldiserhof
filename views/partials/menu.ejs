<%
  // ---- Men√º adat biztons√°gos fallback ----
  const rawMenu = (typeof menuData !== 'undefined' && menuData && typeof menuData === 'object')
    ? menuData
    : {};

  const categories = Array.isArray(rawMenu.categories) ? rawMenu.categories : [];

  // C√≠msorok ‚Äì include-b√≥l, menuData-b√≥l, vagy alap√©rtelmezett DE sz√∂veg
  const titleTxt    = (typeof menuTitle    !== 'undefined' && menuTitle)    ? menuTitle    : (rawMenu.title || 'Speisekarte');
  const subtitleTxt = (typeof menuSubtitle !== 'undefined' && menuSubtitle) ? menuSubtitle : 'Entdecken Sie unsere K√ºche';
  const introTxt    = (typeof menuIntro    !== 'undefined' && menuIntro)    ? menuIntro    : 'Frisch, saisonal, regional ‚Äì t√§glich f√ºr Sie.';

  // Feature flag-ek (pl. menuBookEnabled)
  const safeFlags = (typeof flags !== 'undefined' && flags) ? flags : {};

  // ---- PDF oldalak fallback ----
  const pdfPages = (typeof menuPdfPages !== 'undefined' && Array.isArray(menuPdfPages))
    ? menuPdfPages
    : [];
%>

<section id="menu" class="menu-section">
  <header class="menu-header text-center mb-5">
    <span class="menu-icon" aria-hidden="true">üç¥</span>
    <h2 class="menu-title"><%= titleTxt %></h2>
    <div class="menu-divider"></div>
    <p class="menu-subtitle"><%= subtitleTxt %></p>
    <p class="menu-intro"><%= introTxt %></p>
  </header>

  <!-- K√∂nyv wrapper ‚Äì feature flag + opcion√°lis PDF jelz√©s -->
  <div
    class="menu-portfolio <%= safeFlags.menuBookEnabled ? '' : 'is-locked' %> <%= pdfPages.length ? 'has-pdf' : '' %>"
    data-menu-book-enabled="<%= safeFlags.menuBookEnabled ? '1' : '0' %>"
    data-pdf-count="<%= pdfPages.length %>"
  >
    <div class="wrapper">

      <!-- üîí Ha a men√ºk√∂nyv le van z√°rva, overlay √ºzenet -->
      <% if (!safeFlags.menuBookEnabled) { %>
        <div class="book-lock-overlay" role="status" aria-live="polite">
          <div class="blo-card">
            <h3>Wegen Betriebsferien ist unsere Speisekarte momentan nicht verf√ºgbar.</h3>
            <p>Wir freuen uns, Sie bald wieder begr√º√üen zu d√ºrfen.</p>
          </div>
        </div>
      <% } %>

      <!-- K√ºls≈ë "bor√≠t√≥" effektek -->
      <div class="cover cover-left" aria-hidden="true"></div>
      <div class="cover cover-right" aria-hidden="true"></div>

      <!-- K√∂nyv -->
      <div
        class="book"
        id="menuBook"
        <% if (pdfPages && pdfPages.length) { %>
          data-pdf-pages='<%- JSON.stringify(pdfPages).replace(/<\/(script)/gi, "<\\/$1") %>'
        <% } %>
      >
        
        <!-- === 1. OLDAL (BAL LAP) === -->
        <div class="book-page page-left">
          <div class="profile-page profile-cover">
            <h1><%= titleTxt %></h1>
            <p><%= subtitleTxt %></p>
          </div>
          
          <!-- JAV√çTVA: Gomb hozz√°adva (jobbra ny√≠l) -->
          <button class="nextprev-btn btn-page1-next" data-role="next">‚Ä∫</button>
        </div>

        <!-- === JOBB OLDAL SABLON (Front / Back) === -->
        <div class="book-page page-right" data-sheet="1" id="turn-1" data-template="page">
          
          <!-- 2. oldal (Front) -->
          <div class="page-front">
            <h1 class="title"><%= titleTxt %></h1>

            <!-- Dinamikus men√º (JSON-b√≥l) -->
            <div class="menu-items-grid">
              <% if (!categories || !categories.length) { %>
                <article class="menu-item">
                  <p>Derzeit sind keine Men√ºdaten vorhanden.</p>
                </article>
              <% } %>
            </div>

            <span class="number-page">1</span>

            <!-- JAV√çTVA: Generikus VISSZA gomb (balra ny√≠l) -->
            <button class="nextprev-btn btn-back" data-role="prev">‚Äπ</button>
          </div>

          <!-- 3. oldal (Back) -->
          <div class="page-back">
            <h1 class="title"></h1>
            <div class="menu-items-grid"></div>

            <span class="number-page"></span>

            <!-- JAV√çTVA: Generikus EL≈êRE gomb (jobbra ny√≠l) -->
            <button class="nextprev-btn btn-next" data-role="next">‚Ä∫</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Lapoz√≥ "dot"-ok -->
    <div class="book-dots"></div>
  </div>

  <!-- K√∂nyv CSS + ikonok -->
  <link rel="stylesheet" href="/css/menu-portfolio-book.css">
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">

  <!-- Men√º JSON be√°gyaz√°sa a dinamikus (nem-PDF) m√≥dhoz -->
  <script id="menuDataScript" type="application/json">
    <%- JSON
      .stringify(rawMenu)
      .replace(/<\/(script)/gi, '<\\/$1')
    %>
  </script>

  <!-- PDF oldalak be√°gyaz√°sa (ha a controller √°tadta) -->
  <script id="pdfMenuPagesScript" type="application/json">
    <%- JSON
      .stringify(pdfPages)
      .replace(/<\/(script)/gi, '<\\/$1')
    %>
  </script>

  <!-- Aktiv√°l√≥ JS PDF m√≥dhoz -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const pdfScriptEl = document.getElementById('pdfMenuPagesScript');
      let pdfPages = [];

      if (pdfScriptEl && pdfScriptEl.textContent.trim()) {
        try {
          pdfPages = JSON.parse(pdfScriptEl.textContent.trim());
        } catch (e) {
          console.error('PDF pages JSON parse error in menu-book.ejs:', e);
        }
      }

      if (Array.isArray(pdfPages) && pdfPages.length > 0) {
        window.menuPdfPages = pdfPages;
        document.body.dataset.pdfMenuActive = '1';
      }
    });
  </script>
</section>
<div class="section-separator"></div>
