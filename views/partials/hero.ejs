<%
// --- i18n fallback ---
const T = (typeof t === 'function') ? t : (k => k);

// --- Hasznos utilok ---
const clamp = (v, min, max) => {
  const n = Number(v);
  if (!Number.isFinite(n)) return min;
  return Math.max(min, Math.min(max, n));
};

// --- Csak JPG/JPEG/PNG/WEBP engedélyezése ---
const isValidImage = s => /\.(jpe?g|png|webp)$/i.test(String(s));

// Csak engedélyezett képutak
const isSafePath = s =>
  typeof s === 'string' &&
  s.trim().length > 0 &&
  /^[/.a-zA-Z0-9_\-]+$/.test(s) &&
  (s.startsWith('/img/hero/') || s.startsWith('./img/') || s.startsWith('../img/') || s.startsWith('/img/')) &&
  isValidImage(s);

const normalizePath = s =>
  String(s).replace('/img/her/', '/img/hero/').trim();

// --- Bejövő képek normalizálása ---
const rawList = (typeof heroImages !== 'undefined' && Array.isArray(heroImages)) ? heroImages : [];

const cleaned = rawList
  .filter(isSafePath)
  .map(normalizePath);

// default fallback képek
const FALLBACKS = [
  '/img/hero/feldiserhof-winter.jpg',
  '/img/hero/feldiserhof-sunset.jpg',
  '/img/hero/feldiserhof.jpg',
  '/img/hero/miratoedi.jpg',
  '/img/hero/IMG_03652.jpg'
];

// összeállított végső lista + deduplikálás
const heroImagesList = Array.from(new Set((cleaned.length ? cleaned : FALLBACKS).filter(Boolean)));

// legalább 1 kép legyen
const firstImage = heroImagesList[0] || '/img/hero/feldiserhof.jpg';

// --- Konfig ---
const interval     = clamp((typeof heroInterval     === 'number' ? heroInterval     : 7000),  2500, 60000);
const fadeDuration = clamp((typeof heroFadeDuration === 'number' ? heroFadeDuration : 1600),   200, 10000);

const heroConfig = {
  images: heroImagesList,
  interval,
  fadeDuration,
  enableParallax:   (typeof enableParallax   === 'boolean') ? enableParallax   : true,
  enableAutoPlay:   (typeof enableAutoPlay   === 'boolean') ? enableAutoPlay   : true,
  enableNavigation: (typeof enableNavigation === 'boolean') ? enableNavigation : true,
  enableProgress:   (typeof enableProgress   === 'boolean') ? enableProgress   : true
};

const hasMultiple = heroImagesList.length > 1;

// JSON biztonságos beágyazása
const heroConfigAttr = JSON.stringify(heroConfig)
  .replace(/'/g, '&#39;')
  .replace(/"/g, '&quot;');

// CSS url() biztonságos beágyazása
const cssUrl = (p) => `url('${String(p).replace(/'/g, "\\'").replace(/\\/g, '\\\\')}')`;

// HTML attribute escape helper
const escapeHtml = (str) => String(str)
  .replace(/&/g, '&amp;')
  .replace(/</g, '&lt;')
  .replace(/>/g, '&gt;')
  .replace(/"/g, '&quot;')
  .replace(/'/g, '&#39;');
%>

<header
  id="home"
  class="container-fluid hero-header mb-5 d-flex align-items-center hero"
  data-hero
  data-hero-config='<%- heroConfigAttr %>'
  aria-label="<%= T('hero.sectionLabel') %>"
  role="region"
>
  <!-- Slideshow réteg -->
  <div class="hero-slides" aria-hidden="true" role="presentation">
    <% heroImagesList.forEach((src, i) => { %>
      <img
        class="hero-slide <%= i === 0 ? 'is-active' : '' %>"
        src="<%- src %>"
        alt="<%= escapeHtml(T('hero.imageAlt', { n: i + 1 })) %>"
        loading="<%= i === 0 ? 'eager' : 'lazy' %>"
        decoding="<%= i === 0 ? 'auto' : 'async' %>"
        fetchpriority="<%= i === 0 ? 'high' : 'low' %>"
        draggable="false"
        role="presentation"
        <% if (i > 0) { %>data-lazy="true"<% } %>
      />
    <% }); %>
  </div>

  <% if (heroConfig.enableNavigation && hasMultiple) { %>
    <!-- Navigációs gombok -->
    <nav class="hero-nav" aria-label="<%= T('hero.navigationLabel') %>">
      <button 
        type="button" 
        class="hero-nav-button hero-nav-prev" 
        aria-label="<%= escapeHtml(T('hero.previousImage')) %>"
        tabindex="0"
      >
        <span aria-hidden="true">‹</span>
      </button>
      <button 
        type="button" 
        class="hero-nav-button hero-nav-next" 
        aria-label="<%= escapeHtml(T('hero.nextImage')) %>"
        tabindex="0"
      >
        <span aria-hidden="true">›</span>
      </button>
    </nav>
  <% } %>

  <% if (heroConfig.enableProgress && hasMultiple) { %>
    <!-- Progress indicator -->
    <div class="hero-progress" role="tablist" aria-label="<%= T('hero.progressLabel') %>">
      <% heroImagesList.forEach((image, index) => { %>
        <button
          type="button"
          class="hero-progress-item <%= index === 0 ? 'active' : '' %>"
          data-progress-index="<%= index %>"
          role="tab"
          aria-selected="<%= index === 0 ? 'true' : 'false' %>"
          aria-controls="hero-slide-<%= index %>"
          tabindex="<%= index === 0 ? '0' : '-1' %>"
          aria-label="<%= escapeHtml(T('hero.goToImage', { n: index + 1 })) %>">
          <span class="sr-only"><%= escapeHtml(T('hero.imageNumber', { n: index + 1 })) %></span>
          <div class="progress-fill" aria-hidden="true"></div>
        </button>
      <% }); %>
    </div>
  <% } %>

  <!-- Noscript fallback -->
  <noscript>
    <style>
      .hero-slides::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: <%- cssUrl(firstImage) %>;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
      }
      .hero-progress, .hero-nav { display: none !important; }
    </style>
  </noscript>
</header>

<div class="section-separator" role="separator" aria-hidden="true"></div>
