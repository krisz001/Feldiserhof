<section id="contact" class="container-xxl pt-5 pb-0">
  <div class="container">
    <div class="row g-4 align-items-stretch contact-wrap">

      <!-- Bal: info -->
      <div class="col-lg-5">
        <div class="contact-card h-100 mb-0">
          <h5 class="section-title ff-secondary text-start fw-normal mb-2">Kontakt</h5>
          <h1 class="mb-3 contact-headline">So erreichen Sie uns</h1>

          <p class="mb-4">
            Haben Sie Fragen oder möchten reservieren? Rufen Sie uns an oder schreiben Sie uns eine Nachricht.
          </p>

          <ul class="list-unstyled fs-5 mb-4">
            <!-- Cím + route -->
            <li class="mb-3 d-flex align-items-start contact-item">
              <i class="fas fa-map-marker-alt icon" aria-hidden="true"></i>
              <div>
                <a
                  href="https://www.google.com/maps/place/Feldiserhof,+7404+Feldis,+Schweiz"
                  target="_blank" rel="noopener noreferrer"
                  class="contact-link">
                  Feldiserhof, 7404 Feldis, Schweiz
                </a>
                <div>
                  <a
                    href="https://www.google.com/maps/dir/?api=1&destination=Feldiserhof,+7404+Feldis,+Schweiz"
                    target="_blank" rel="noopener noreferrer"
                    class="contact-link with-icon">
                    <i class="fas fa-map-location-dot" aria-hidden="true"></i>
                    <span>Route anzeigen</span>
                  </a>
                </div>
              </div>
            </li>

            <!-- Telefon + magyarázó szöveg szép blokkban -->
            <li class="mb-3 d-flex align-items-start contact-item">
              <i class="fas fa-phone icon" aria-hidden="true"></i>
              <div class="contact-text">
                <a href="tel:+41816552004" class="contact-link d-block fw-semibold">
                  +41 81 655 20 04
                </a>
                <small class="contact-note d-block">
                  Restaurant
                </small>
                <a href="tel:+41795992004" class="contact-link d-block fw-semibold">
                  +41 79 599 20 04
                </a>
                <small class="contact-note d-block">
                  Direktion & Rezeption Karin Huber
                </small>
              </div>
            </li>

            <!-- E-mail -->
            <li class="mb-3 d-flex align-items-center contact-item">
              <i class="fas fa-envelope icon" aria-hidden="true"></i>
              <a href="mailto:info@feldiserhof.ch" class="contact-link">info@feldiserhof.ch</a>
            </li>
          </ul>

          <div class="mb-4">
            <a class="btn btn-primary me-2" href="tel:+41816513030" aria-label="Anrufen">Anrufen</a>
            <a class="btn btn-outline-primary" href="mailto:info@feldiserhof.ch" aria-label="E-Mail senden">E-Mail</a>
          </div>

          <!-- NYITVATARTÁS STÁTUSZ ÉS ÓRÁK -->
          <h5 class="mt-2 section-title">Öffnungszeiten</h5>
          
          <!-- Státusz badge és szöveg -->
          <div class="d-flex align-items-center gap-2 mb-3">
            <span id="badgeOpen" class="badge bg-success d-none">GEÖFFNET</span>
            <span id="badgeClosed" class="badge bg-danger d-none">GESCHLOSSEN</span>
            <span id="statusText" class="small text-muted"></span>
          </div>
          
          <!-- Órák lista -->
          <ul id="hoursList" class="list-unstyled mt-2 small mb-0"></ul>
        </div>
      </div>

      <!-- Jobb: térkép -->
      <div class="col-lg-7 d-flex">
        <div class="map-card rounded-4 shadow-sm flex-grow-1 mb-0">
          <div class="ratio ratio-16x9 map-ratio">
            <iframe
              title="Karte – Feldiserhof"
              src="https://www.google.com/maps?q=Feldiserhof,+Feldis,+Schweiz&output=embed"
              class="d-block"
              loading="lazy"
              allowfullscreen
              referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- JAVASCRIPT A NYITVATARTÁS BETÖLTÉSÉHEZ -->
<script>
  (() => {
    const badgeOpen = document.getElementById('badgeOpen');
    const badgeClosed = document.getElementById('badgeClosed');
    const statusText = document.getElementById('statusText');
    const hoursList = document.getElementById('hoursList');

    const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

    // Dátum formázás: 2025-11-25 → 25.11.
    function formatDateShort(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}.${month}.`;
    }

    async function loadOpeningHours() {
      try {
        const res = await fetch('/api/opening-hours');
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();

        // ===== 1. FORCE CLOSE CHECK (MANUÁLIS ZÁRVA) =====
        if (data.forceCloseForTesting) {
          badgeClosed.classList.remove('d-none');
          badgeOpen.classList.add('d-none');
          statusText.textContent = 'Bis auf weiteres geschlossen';
          
          hoursList.innerHTML = dayNames.map(day => `
            <li class="d-flex justify-content-between py-1 border-bottom">
              <span class="fw-semibold">${day}</span>
              <span class="text-danger">geschlossen</span>
            </li>
          `).join('');
          
          return; // NEM MEGYÜNK TOVÁBB
        }

        // ===== 2. EXCEPTIONS CHECK (IDŐSZAKOS ZÁRVA) =====
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        if (data.exceptions && Array.isArray(data.exceptions)) {
          for (const exc of data.exceptions) {
            if (exc.type === 'closed' && exc.start && exc.end) {
              if (todayStr >= exc.start && todayStr <= exc.end) {
                // MA EXCEPTION IDŐSZAKBAN VAGYUNK
                badgeClosed.classList.remove('d-none');
                badgeOpen.classList.add('d-none');
                statusText.textContent = `Geschlossen – bis einschließlich ${formatDateShort(exc.end)}`;
                
                hoursList.innerHTML = dayNames.map(day => `
                  <li class="d-flex justify-content-between py-1 border-bottom">
                    <span class="fw-semibold">${day}</span>
                    <span class="text-danger">geschlossen</span>
                  </li>
                `).join('');
                
                return; // NEM MEGYÜNK TOVÁBB
              }
            }
          }
        }

        // ===== 3. NORMÁLIS MŰKÖDÉS (NYITVA) =====
        badgeOpen.classList.remove('d-none');
        badgeClosed.classList.add('d-none');
        statusText.textContent = '';

        const week = data.week || {};
        
        hoursList.innerHTML = dayNames.map((dayName, idx) => {
          const dayKey = String(idx);
          const times = week[dayKey] || [];
          
          let timeStr;
          if (times.length === 0) {
            timeStr = '<span class="text-muted">geschlossen</span>';
          } else {
            const firstSlot = times[0];
            timeStr = `${firstSlot[0] || '–'} – ${firstSlot[1] || '–'}`;
          }
          
          return `
            <li class="d-flex justify-content-between py-1 border-bottom">
              <span class="fw-semibold">${dayName}</span>
              <span>${timeStr}</span>
            </li>
          `;
        }).join('');

      } catch (err) {
        console.error('Opening hours load error:', err);
        badgeClosed.classList.remove('d-none');
        badgeOpen.classList.add('d-none');
        statusText.textContent = 'Öffnungszeiten nicht verfügbar';
        hoursList.innerHTML = '<li class="text-muted">Fehler beim Laden</li>';
      }
    }

    loadOpeningHours();
  })();
</script>
